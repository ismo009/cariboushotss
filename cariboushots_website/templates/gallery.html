{% extends "base.html" %}

{% block title %}
    {% if current_folder_name %}
        {{ current_folder_name }} - Galerie
    {% else %}
        Galerie Photo
    {% endif %}
{% endblock %}

{% block content %}
<div class="gallery-container">
    <h2>Galerie Photo du Club</h2>

    <h3>
        Actuellement dans :
        <a href="{{ url_for('gallery', folder_id=current_folder_id if current_folder_id != MAIN_CLUB_FOLDER_ID else None) }}">
            {{ current_folder_name }}
        </a>
    </h3>

    {# Back navigation link #}
    {% if current_folder_id != MAIN_CLUB_FOLDER_ID %} {# Only show 'Back' if not in the root of the gallery #}
        <div class="back-navigation">
            <a href="{{ url_for('gallery', folder_id=parent_folder_id if parent_folder_id else None) }}" class="back-link">
                <span class="back-arrow">‚Üê</span>
                <span class="back-text">
                    Retour vers
                    {% if parent_folder_id %}
                        le dossier pr√©c√©dent
                    {% else %}
                        la Galerie Principale
                    {% endif %}
                </span>
            </a>
        </div>
    {% endif %}

    {% if folders %}
        <h4>Sous-dossiers :</h4>
        <ul class="folder-list">
            {% for folder in folders %}
                <li>
                    <a href="{{ url_for('gallery', folder_id=folder.id) }}">{{ folder.name }}</a>
                </li>
            {% endfor %}
        </ul>
    {% else %}
        <p>Aucun sous-dossier trouv√© dans {{ current_folder_name }}.</p>
    {% endif %}

    <hr>

    {% if photos %}
        <h4>Photos dans {{ current_folder_name }} :</h4>
        <div class="photo-grid">
            {% for photo in photos %}
                <div class="photo-item">
                    <div class="photo-preview" onclick="openPhotoModal('{{ photo.id }}', '{{ photo.name }}', '{{ photo.webContentLink if photo.webContentLink else '' }}', '{{ photo.thumbnailLink if photo.thumbnailLink else url_for('static', filename='images/placeholder_image.png') }}')">
                        <div class="photo-image-container">
                            <img src="{{ photo.thumbnailLink if photo.thumbnailLink else url_for('static', filename='images/placeholder_image.png') }}"
                                 alt="{{ photo.name }}"
                                 onerror="this.onerror=null; this.src='{{ url_for('static', filename='images/placeholder_image.png') }}';">
                        </div>
                        <p>{{ photo.name }}</p>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <p>Aucune photo trouv√©e dans {{ current_folder_name }}.</p>
    {% endif %}

</div>

<!-- Modal de pr√©visualisation des photos -->
<div id="photoModal" class="photo-modal" onclick="closePhotoModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h3 id="modalPhotoName">Nom de la photo</h3>
            <button class="close-btn" onclick="closePhotoModal()">&times;</button>
        </div>
        <div class="modal-body">
            <img id="modalPhotoImg" src="" alt="Pr√©visualisation photo">
        </div>
        <div class="modal-footer">
            <button id="modalViewBtn" class="modal-btn view-btn-modal" onclick="openInGoogleDrive()">
                üîó Voir sur Google Drive
            </button>
            <button id="modalDownloadBtn" class="modal-btn download-btn-modal" onclick="downloadPhoto()">
                ‚¨áÔ∏è T√©l√©charger la photo
            </button>
        </div>
    </div>
</div>

<script>
let currentPhotoData = {};
let modalImageLoaded = false;

function openPhotoModal(photoId, photoName, downloadLink, thumbnailLink) {
    currentPhotoData = {
        id: photoId,
        name: photoName,
        downloadLink: downloadLink,
        thumbnailLink: thumbnailLink
    };
    
    // Reset modal state
    modalImageLoaded = false;
    const modalImg = document.getElementById('modalPhotoImg');
    const modal = document.getElementById('photoModal');
    
    // Set modal content
    document.getElementById('modalPhotoName').textContent = photoName;
    
    // Show loading state
    modalImg.style.opacity = '0.5';
    modalImg.src = '';
    
    // Show modal avec la nouvelle m√©thode simple
    modal.classList.add('show');
    document.body.style.overflow = 'hidden';
    
    // Load image with better error handling
    const img = new Image();
    img.onload = function() {
        modalImg.src = this.src;
        modalImg.style.opacity = '1';
        modalImageLoaded = true;
    };
    
    img.onerror = function() {
        // Fallback to placeholder if thumbnail fails
        modalImg.src = "{{ url_for('static', filename='images/placeholder_image.png') }}";
        modalImg.style.opacity = '1';
        modalImageLoaded = true;
        console.warn('Failed to load image:', thumbnailLink);
    };
    
    // Try to load higher quality image first, fallback to thumbnail
    if (downloadLink && downloadLink.includes('export?')) {
        // Convert download link to view link for better quality
        const viewLink = downloadLink.replace('/export?', '/view?').replace('&export=download', '');
        img.src = viewLink;
    } else {
        img.src = thumbnailLink;
    }
}

function centerModal() {
    // Plus besoin de cette fonction avec le positionnement absolu
    // Le CSS se charge de tout
}

function closePhotoModal() {
    const modal = document.getElementById('photoModal');
    const modalImg = document.getElementById('modalPhotoImg');
    
    // Reset image
    modalImg.src = '';
    modalImg.style.opacity = '1';
    
    // Hide modal simplement
    modal.classList.remove('show');
    document.body.style.overflow = 'auto';
    
    // Reset data
    currentPhotoData = {};
    modalImageLoaded = false;
}

function openInGoogleDrive() {
    if (currentPhotoData.downloadLink) {
        // Convert download link to proper Google Drive view link
        let viewLink = currentPhotoData.downloadLink;
        if (viewLink.includes('/export?')) {
            viewLink = viewLink.replace('/export?', '/view?').replace('&export=download', '');
        }
        window.open(viewLink, '_blank');
    } else {
        alert('Lien Google Drive non disponible pour cette photo.');
    }
}

function downloadPhoto() {
    if (currentPhotoData.downloadLink) {
        try {
            // Create download link
            const link = document.createElement('a');
            link.href = currentPhotoData.downloadLink;
            link.download = currentPhotoData.name;
            link.target = '_blank';
            link.style.display = 'none';
            
            // Add to DOM, click, and remove
            document.body.appendChild(link);
            link.click();
            
            // Clean up after a short delay
            setTimeout(() => {
                document.body.removeChild(link);
            }, 100);
            
        } catch (error) {
            console.error('Download failed:', error);
            alert('Erreur lors du t√©l√©chargement. Essayez d\'ouvrir la photo dans Google Drive.');
        }
    } else {
        alert('Lien de t√©l√©chargement non disponible pour cette photo.');
    }
}

// Enhanced keyboard controls
document.addEventListener('keydown', function(event) {
    const modal = document.getElementById('photoModal');
    if (modal.classList.contains('show')) {
        switch(event.key) {
            case 'Escape':
                closePhotoModal();
                break;
            case 'Enter':
                if (event.ctrlKey || event.metaKey) {
                    downloadPhoto();
                } else {
                    openInGoogleDrive();
                }
                break;
            case 'd':
            case 'D':
                if (event.ctrlKey || event.metaKey) {
                    event.preventDefault();
                    downloadPhoto();
                }
                break;
        }
    }
});

// Prevent modal from closing when clicking on image
document.addEventListener('DOMContentLoaded', function() {
    const modalContent = document.querySelector('.modal-content');
    if (modalContent) {
        modalContent.addEventListener('click', function(event) {
            event.stopPropagation();
        });
    }
});

// Handle touch events for mobile
let touchStartY = 0;
let touchEndY = 0;

document.addEventListener('touchstart', function(event) {
    const modal = document.getElementById('photoModal');
    if (modal.style.display === 'flex') {
        touchStartY = event.changedTouches[0].screenY;
    }
});

document.addEventListener('touchend', function(event) {
    const modal = document.getElementById('photoModal');
    if (modal.style.display === 'flex') {
        touchEndY = event.changedTouches[0].screenY;
        handleSwipe();
    }
});

function handleSwipe() {
    const swipeThreshold = 50;
    const diff = touchStartY - touchEndY;
    
    // Swipe down to close modal
    if (diff < -swipeThreshold) {
        closePhotoModal();
    }
}
</script>
{% endblock %}
